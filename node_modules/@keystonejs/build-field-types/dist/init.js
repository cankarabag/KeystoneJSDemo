"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = init;

var _project = require("./project");

var _errors = require("./errors");

var _logger = require("./logger");

var _messages = require("./messages");

var _validate = require("./validate");

async function init(directory) {
  let project = await _project.Project.create(directory);
  await Promise.all(project.packages.map(async pkg => {
    pkg.entrypoints.forEach(entrypoint => {
      (0, _validate.validateEntrypointSource)(entrypoint);
    });

    if (pkg.entrypoints.every(entrypoint => (0, _validate.isMainFieldValid)(entrypoint)) && pkg.entrypoints.every(entrypoint => (0, _validate.isModuleFieldValid)(entrypoint))) {
      (0, _logger.info)(_messages.infos.validMainField, pkg);
    } else {
      let canWriteMainModuleFields = await _messages.confirms.writeMainModuleFields(pkg);

      if (!canWriteMainModuleFields) {
        throw new _errors.FixableError(_messages.errors.deniedWriteMainModuleFields, pkg);
      }

      pkg.setFieldOnEntrypoints('main');
      pkg.setFieldOnEntrypoints('module');
    }

    await Promise.all(pkg.entrypoints.map(x => x.save()));
  }));
  (0, _logger.success)('initialised project!');
}