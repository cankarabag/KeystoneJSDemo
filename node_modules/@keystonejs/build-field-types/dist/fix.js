"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fixPackage = fixPackage;
exports.default = fix;

var _project = require("./project");

var _logger = require("./logger");

var _validate = require("./validate");

var _errors = require("./errors");

var _messages = require("./messages");

/*::
import { Package } from "./package";
*/
async function fixPackage(pkg) {
  if (pkg.entrypoints.length === 0) {
    throw new _errors.FatalError(_messages.errors.noEntrypoints, pkg);
  }

  pkg.setFieldOnEntrypoints('main');
  pkg.setFieldOnEntrypoints('module');
  return (await Promise.all(pkg.entrypoints.map(x => x.save()))).some(x => x);
}

async function fix(directory) {
  let {
    packages
  } = await _project.Project.create(directory);
  let didModify = (await Promise.all(packages.map(async pkg => {
    pkg.entrypoints.forEach(_validate.validateEntrypointSource);
    let didModifyInPkgFix = await fixPackage(pkg);
    return didModifyInPkgFix;
  }))).some(x => x);
  (0, _logger.success)(didModify ? `fixed project!` : `project already valid!`);
}